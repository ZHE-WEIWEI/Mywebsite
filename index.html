<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ä»²èè‹± CRM Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; border-radius: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 10px 15px -5px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; transition: all 0.2s; }
        .card-hover:hover { border-color: #dbeafe; background-color: #fdfdfd; }
        
        .form-input-std {
            width: 100%;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 0.875rem;
            font-weight: 700;
            transition: all 0.2s;
        }
        .form-input-std:focus {
            background-color: #ffffff;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #bfdbfe;
            outline: none;
        }

        .status-select { 
            padding: 4px 12px; 
            border-radius: 999px; 
            font-size: 0.75rem; 
            font-weight: 800; 
            border: none; 
            appearance: none; 
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .border-male { border: 2px solid #60a5fa !important; border-left-width: 8px !important; }
        .border-female { border: 2px solid #f472b6 !important; border-left-width: 8px !important; }
        .border-other { border: 2px solid #cbd5e1 !important; border-left-width: 8px !important; }

        .info-pill { background: #f8fafc; border: 1px solid #f1f5f9; padding: 6px 14px; border-radius: 10px; font-size: 11px; font-weight: 700; color: #475569; display: inline-flex; align-items: center; gap: 4px; min-width: 80px; justify-content: center; }
        .area-tag { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .area-tag:hover { background: #dbeafe; text-decoration: underline; }
        
        .building-tag { background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 3px; }
        .building-tag:hover { background: #fee2e2; text-decoration: underline; }

        .note-tag { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; }

        .filter-select { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 8px 12px; font-size: 12px; font-weight: 700; outline: none; transition: all 0.2s; width: 100%; }
        .filter-date-search { background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; padding: 10px 12px; font-size: 13px; font-weight: 800; outline: none; transition: all 0.2s; width: 100%; color: #1e293b; height: 48px; }

        .modal-bg { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); }
        
        .text-empty { color: #94a3b8; font-weight: 500; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .quick-insert-btn { padding: 4px 8px; font-size: 10px; font-weight: 700; background: white; color: #64748b; border: 1px solid #e2e8f0; border-radius: 8px; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
        .quick-insert-btn:hover { border-color: #3b82f6; color: #2563eb; background: #eff6ff; transform: translateY(-1px); }

        .note-quick-tag { font-size: 10px; padding: 3px 8px; background: #f1f5f9; color: #475569; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; font-weight: 600; }
        .note-quick-tag:hover { background: #e2e8f0; color: #1e293b; border-color: #cbd5e1; }

        .budget-badge {
            background: #1e3a8a;
            color: #ffffff;
            font-size: 14px;
            font-weight: 900;
            padding: 8px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255,255,255,0.1);
            letter-spacing: -0.025em;
        }
    </style>
</head>
<body class="p-3 md:p-6">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
            <h1 class="text-2xl md:text-3xl font-black text-slate-900 italic tracking-tighter">CRM <span class="text-blue-600">PRO</span></h1>
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="text-[10px] font-bold text-slate-400 bg-white px-3 py-1 rounded-full border border-slate-100 hidden lg:block">æ™ºæ…§å®¢ç®¡ç³»çµ± v4.7</div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="exportToCSV()" class="flex-1 md:flex-none px-4 py-2 bg-white text-slate-600 border border-slate-200 rounded-xl text-xs font-bold hover:bg-slate-50">ğŸ“¤ åŒ¯å‡º</button>
                    <label class="flex-1 md:flex-none px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold cursor-pointer hover:bg-slate-900 text-center">
                        ğŸ“¥ åŒ¯å…¥
                        <input type="file" id="importFile" accept=".csv" class="hidden" onchange="importFromCSV(this)">
                    </label>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6 md:gap-8">
            <!-- æ–°å¢/ç·¨è¼¯å€ -->
            <section class="card p-5 md:p-6 h-fit lg:col-span-1 lg:sticky lg:top-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="formTitle" class="text-lg font-black text-slate-800">æ–°å¢è²·æ–¹</h2>
                    <button onclick="resetForm()" class="text-[10px] font-bold text-slate-400 hover:text-blue-500 underline">é‡è¨­</button>
                </div>
                <form id="mainForm" class="space-y-4">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <div class="space-y-3">
                        <input type="text" id="inputName" placeholder="å§“å (ä¾‹: æ—å…ˆç”Ÿ /å°å§)" class="form-input-std" required>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="inputCode" placeholder="ç°¡ç¢¼ (ä¾‹: A01)" class="form-input-std">
                            <select id="inputStatus" class="form-input-std">
                                <option value="ç¶“ç‡Ÿä¸­">ğŸ”„ ç¶“ç‡Ÿä¸­</option>
                                <option value="Aè²·">ğŸŒŸ Aè²·</option>
                                <option value="å¤±è¯ä¸­">ğŸ“µ å¤±è¯ä¸­</option>
                                <option value="å¸¶çœ‹é">ğŸ‘€ å¸¶çœ‹é</option>
                                <option value="LINEå¥½å‹">ğŸ’¬ LINEå¥½å‹</option>
                                <option value="ä¸ç¶“ç‡Ÿ">ä¸ç¶“ç‡Ÿ</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="inputPhone" placeholder="é›»è©±" class="form-input-std">
                            <input type="text" id="inputLine" placeholder="LINE ID" class="form-input-std">
                        </div>
                        <input type="text" id="inputAddress" placeholder="é€šè¨Šåœ°å€ (ç©ºç™½é¡¯ç¤ºæœªå¡«)" class="form-input-std">
                    </div>

                    <div class="p-4 bg-blue-50/50 rounded-2xl border border-blue-100 space-y-4">
                        <p class="text-[10px] font-black text-blue-500 uppercase italic">ğŸ“‹ è³¼å±‹éœ€æ±‚è©³æƒ…</p>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <div class="flex flex-col gap-2 sm:flex-row">
                                <select id="inputType" class="flex-1 bg-white border border-slate-200 rounded-xl p-3 text-[11px] font-bold shadow-sm outline-none">
                                    <option value="">é¡å‹ä¸é™</option>
                                    <option value="é›»æ¢¯å¤§æ¨“">é›»æ¢¯å¤§æ¨“</option><option value="è¯å»ˆ">è¯å»ˆ</option><option value="å…¬å¯“">å…¬å¯“</option><option value="é€å¤©">é€å¤©</option><option value="åˆ¥å¢…">åˆ¥å¢…</option><option value="åº—é¢">åº—é¢</option>
                                </select>
                                <select id="inputParking" class="flex-1 bg-white border border-slate-200 rounded-xl p-3 text-[11px] font-bold shadow-sm outline-none">
                                    <option value="">è»Šä½ä¸é™</option>
                                    <option value="å¡é“å¹³é¢">å¡é“å¹³é¢</option>
                                    <option value="å¡é“æ©Ÿæ¢°">å¡é“æ©Ÿæ¢°</option>
                                    <option value="æ˜‡é™å¹³é¢">æ˜‡é™å¹³é¢</option>
                                    <option value="æ˜‡é™æ©Ÿæ¢°">æ˜‡é™æ©Ÿæ¢°</option>
                                    <option value="ä¸éœ€è¦">ä¸éœ€è¦</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-3 gap-2">
                                <div class="flex flex-col">
                                    <label class="text-[9px] text-slate-400 mb-1 ml-1 font-bold">é ç®—(è¬)</label>
                                    <input type="text" id="inputBudget" placeholder="é ç®—" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 text-[11px] font-bold shadow-sm text-center">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[9px] text-slate-400 mb-1 ml-1 font-bold">æˆ¿/è¡›</label>
                                    <input type="text" id="inputRoomRange" placeholder="3/2" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 text-[11px] font-bold shadow-sm text-center">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[9px] text-slate-400 mb-1 ml-1 font-bold">æ¨“å±¤</label>
                                    <input type="text" id="inputFloor" placeholder="æ¨“å±¤" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 text-[11px] font-bold shadow-sm text-center">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div class="flex flex-col">
                                    <label class="text-[9px] text-slate-400 mb-1 ml-1 font-bold">åªæ•¸</label>
                                    <input type="text" id="inputSize" placeholder="åªæ•¸" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 text-[11px] font-bold shadow-sm text-center">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[9px] text-slate-400 mb-1 ml-1 font-bold">å±‹é½¡</label>
                                    <input type="text" id="inputAge" placeholder="å±‹é½¡" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 text-[11px] font-bold shadow-sm text-center">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <input type="text" id="inputArea" placeholder="å€åŸŸéœ€æ±‚ (ä¾‹: æ¿æ©‹ åºœä¸­)" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-[11px] font-bold shadow-sm">
                            <input type="text" id="inputBuilding" placeholder="å¤§æ¨“/ç¤¾å€åç¨± (ç©ºæ ¼æ¨™ç±¤)" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-[11px] font-bold shadow-sm">
                        </div>
                        
                        <div class="space-y-3">
                            <textarea id="inputNote" rows="2" placeholder="å‚™è¨»æ¨™ç±¤æè¿°" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-[11px] font-bold shadow-sm resize-none outline-none focus:border-blue-300"></textarea>
                            <div class="flex flex-wrap gap-1.5 max-h-[120px] overflow-y-auto pr-1 custom-scroll">
                                <span class="note-quick-tag" onclick="insertQuickTag('æ’é™¤é ‚æ¨“')">æ’é™¤é ‚æ¨“</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('æ’é™¤å¤¾å±¤')">æ’é™¤å¤¾å±¤</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('å¤©ç„¶ç“¦æ–¯')">å¤©ç„¶ç“¦æ–¯</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('ä¸€æ¨“å¥½åœ')">ä¸€æ¨“å¥½åœ</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('é‚Šé–“')">é‚Šé–“</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('å°å¤–çª—')">å°å¤–çª—</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('ç„¡éšœç¤™')">ç„¡éšœç¤™</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('æ ¼å±€æ–¹æ­£')">æ ¼å±€æ–¹æ­£</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('éå‡¶å®…')">éå‡¶å®…</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('é ‚æ¨“åŠ è“‹')">é ‚æ¨“åŠ è“‹</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('æ”¶ç§Ÿå±‹')">æ”¶ç§Ÿå±‹</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('ç„¡æš—æˆ¿')">ç„¡æš—æˆ¿</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('ç¥æ˜å»³')">ç¥æ˜å»³</span>
                                <span class="note-quick-tag" onclick="insertQuickTag('ç„¡æ¼æ°´å£ç™Œ')">ç„¡æ¼æ°´å£ç™Œ</span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="w-full btn-primary text-white font-black py-4 rounded-xl shadow-lg mt-2">å„²å­˜å®¢æˆ¶è³‡æ–™</button>
                </form>
            </section>

            <!-- åˆ—è¡¨å€ -->
            <section class="lg:col-span-3 space-y-4">
                <div class="card p-4 md:p-5 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="relative group md:col-span-8">
                            <label class="block text-[10px] font-black text-slate-400 mb-1 pl-1 uppercase">ğŸ” æœå°‹ (å§“å/é›»è©±/åœ°å€/å¤§æ¨“/æ—¥èªŒ)</label>
                            <div class="relative">
                                <span class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                                <input type="text" id="searchInput" oninput="render()" placeholder="è¼¸å…¥é—œéµå­—..." class="w-full pl-12 pr-6 py-3.5 rounded-xl border-none bg-slate-50 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div class="md:col-span-4">
                            <div class="flex items-center justify-between mb-1 pl-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase">ğŸ“… æ¥æ´½æ—¥æœŸæœå°‹</label>
                                <button onclick="clearDateFilter()" class="text-[9px] font-bold text-blue-500 hover:underline">æ¸…é™¤</button>
                            </div>
                            <input type="date" id="searchLogDate" onchange="render()" class="filter-date-search">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 md:gap-3">
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-black text-slate-400 pl-1">ç‹€æ…‹</label>
                            <select id="filterStatus" onchange="render()" class="filter-select"><option value="å…¨éƒ¨">å…¨éƒ¨</option><option value="ç¶“ç‡Ÿä¸­">ç¶“ç‡Ÿä¸­</option><option value="Aè²·">Aè²·</option><option value="å¤±è¯ä¸­">å¤±è¯ä¸­</option><option value="å¸¶çœ‹é">å¸¶çœ‹é</option><option value="LINEå¥½å‹">LINEå¥½å‹</option><option value="ä¸ç¶“ç‡Ÿ">ä¸ç¶“ç‡Ÿ</option></select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-black text-slate-400 pl-1">é¡å‹</label>
                            <select id="filterType" onchange="render()" class="filter-select"><option value="å…¨éƒ¨">å…¨éƒ¨</option><option value="é›»æ¢¯å¤§æ¨“">é›»æ¢¯å¤§æ¨“</option><option value="è¯å»ˆ">è¯å»ˆ</option><option value="å…¬å¯“">å…¬å¯“</option><option value="é€å¤©">é€å¤©</option><option value="åˆ¥å¢…">åˆ¥å¢…</option><option value="åº—é¢">åº—é¢</option></select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-black text-slate-400 pl-1">é ç®—</label>
                            <select id="filterBudget" onchange="render()" class="filter-select"><option value="ä¸é™">ä¸é™</option><option value="1000â†“">1000â†“</option><option value="1000-2000">1K-2K</option><option value="2000-3500">2K-3.5K</option><option value="3500-5000">3.5K-5K</option><option value="5000â†‘">5000â†‘</option></select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-black text-slate-400 pl-1">æˆ¿æ•¸</label>
                            <select id="filterRoom" onchange="render()" class="filter-select"><option value="ä¸é™">ä¸é™</option><option value="1">1æˆ¿</option><option value="2">2æˆ¿</option><option value="3">3æˆ¿</option><option value="4">4æˆ¿+</option></select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-black text-slate-400 pl-1">å±‹é½¡</label>
                            <select id="filterAge" onchange="render()" class="filter-select"><option value="ä¸é™">ä¸é™</option><option value="5">5å¹´å…§</option><option value="5-15">5-15å¹´</option><option value="15-30">15-30å¹´</option><option value="30">30å¹´ä»¥ä¸Š</option></select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-black text-slate-400 pl-1">åªæ•¸</label>
                            <select id="filterSize" onchange="render()" class="filter-select"><option value="ä¸é™">ä¸é™</option><option value="20â†“">20â†“</option><option value="20-40">20-40</option><option value="40-60">40-60</option><option value="60â†‘">60â†‘</option></select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-black text-slate-400 pl-1">è»Šä½</label>
                            <select id="filterParking" onchange="render()" class="filter-select">
                                <option value="ä¸é™">ä¸é™</option>
                                <option value="å¡é“å¹³é¢">å¡é“å¹³é¢</option>
                                <option value="å¡é“æ©Ÿæ¢°">å¡é“æ©Ÿæ¢°</option>
                                <option value="æ˜‡é™å¹³é¢">æ˜‡é™å¹³é¢</option>
                                <option value="æ˜‡é™æ©Ÿæ¢°">æ˜‡é™æ©Ÿæ¢°</option>
                                <option value="ä¸éœ€è¦">ä¸éœ€è¦</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="dataList" class="grid grid-cols-1 gap-4"></div>
            </section>
        </main>
    </div>

    <!-- ç·¨è¼¯å½ˆçª— -->
    <div id="logModal" class="fixed inset-0 z-[60] hidden modal-bg flex items-center justify-center p-2 md:p-4">
        <div class="card w-full max-w-5xl bg-white p-4 md:p-6 h-[95vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl md:text-2xl font-black text-slate-800" id="logModalTitle">ç¶“ç‡Ÿè©³æƒ…</h3>
                <button onclick="closeLogModal()" class="text-3xl text-slate-400 hover:text-red-500 px-2">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="flex flex-col h-[320px] bg-amber-50/50 p-4 rounded-2xl border border-amber-100">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-[11px] font-black text-amber-600">â­ å®¢æˆ¶ç‰¹è³ªèˆ‡é•·æœŸç­†è¨˜</label>
                        <button onclick="updateAdminNoteInModal()" class="px-3 py-1.5 bg-amber-500 text-white rounded-lg text-[10px] font-black hover:bg-amber-600">å„²å­˜ç‰¹è³ª</button>
                    </div>
                    <textarea id="modalAdminNote" class="w-full flex-1 bg-white border border-amber-200 rounded-xl p-3 text-sm font-bold outline-none resize-none custom-scroll leading-relaxed" placeholder="è¨˜éŒ„å®¢æˆ¶åå¥½ã€å®¶åº­æˆå“¡..."></textarea>
                    <div class="flex flex-wrap gap-1.5 mt-3">
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ“ æ™šé»å†æ‰“')" class="quick-insert-btn">ğŸ“ æ™šé»æ‰“</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ“… éš”æ—¥å†æ‰“')" class="quick-insert-btn">ğŸ“… éš”æ—¥æ‰“</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸŒ± æŒçºŒç¶“ç‡Ÿ')" class="quick-insert-btn">ğŸŒ± æŒçºŒç¶“ç‡Ÿ</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ” éœ€æ±‚æ¢ç´¢')" class="quick-insert-btn">ğŸ” éœ€æ±‚æ¢ç´¢</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸš€ æŒçºŒè·Ÿé€²')" class="quick-insert-btn">ğŸš€ æŒçºŒè·Ÿé€²</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ’° é ç®—å•é¡Œ')" class="quick-insert-btn">ğŸ’° é ç®—å•é¡Œ</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ™… ä¸è²·äº†')" class="quick-insert-btn">ğŸ™… ä¸è²·äº†</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ  æ–°å©šé¦–è³¼')" class="quick-insert-btn">ğŸ  æ–°å©šé¦–è³¼</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ¼ å°æ›å¤§')" class="quick-insert-btn">ğŸ¼ å°æ›å¤§</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ¦ é¦–è³¼å„ªè²¸')" class="quick-insert-btn">ğŸ¦ é¦–è³¼å„ªè²¸</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ›¡ï¸ é‡è¦–å±‹æ³')" class="quick-insert-btn">ğŸ›¡ï¸ é‡è¦–å±‹æ³</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸšŒ é€šå‹¤å„ªå…ˆ')" class="quick-insert-btn">ğŸšŒ é€šå‹¤å„ªå…ˆ</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ¤¯ è§€æœ›çŒ¶è±«')" class="quick-insert-btn">ğŸ¤¯ è§€æœ›çŒ¶è±«</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ’° æŠ•å ±ç‡é«˜')" class="quick-insert-btn">ğŸ’° æŠ•å ±ç‡é«˜</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸï¸ æ™¯è§€é¦–é¸')" class="quick-insert-btn">ğŸï¸ æ™¯è§€é¦–é¸</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸ‘¥ é„°å±…ç´ è³ª')" class="quick-insert-btn">ğŸ‘¥ é„°å±…ç´ è³ª</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸŒ¡ï¸ ç†± (æˆäº¤åœ¨å³)')" class="quick-insert-btn">ğŸŒ¡ï¸ ç†± (æˆäº¤åœ¨å³)</button>
                        <button onclick="insertQuick('modalAdminNote', 'ğŸŒ¤ï¸ æº« (ç©©å®šè·Ÿé€²)')" class="quick-insert-btn">ğŸŒ¤ï¸ æº« (ç©©å®šè·Ÿé€²)</button>
                        <button onclick="insertQuick('modalAdminNote', 'â„ï¸ å†· (æš«ç„¡éœ€æ±‚)')" class="quick-insert-btn">â„ï¸ å†· (æš«ç„¡éœ€æ±‚)</button>
                    </div>
                </div>
                <div class="flex flex-col h-[320px] bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <label class="text-[11px] font-black text-emerald-600" id="logFormTitle">âœï¸ ç•¶æ¬¡æ¥æ´½ç´€éŒ„</label>
                            <input type="date" id="logDate" class="text-[10px] font-bold bg-white border border-emerald-200 rounded-lg px-2.5 py-1.5 outline-none">
                        </div>
                        <button onclick="saveNewLog()" id="btnSaveLog" class="px-4 py-1.5 bg-emerald-600 text-white rounded-lg text-[11px] font-black hover:bg-emerald-700 shadow-sm">å„²å­˜æ—¥èªŒ</button>
                    </div>
                    <textarea id="newLogContent" class="w-full flex-1 bg-white border border-emerald-200 rounded-xl p-3 text-sm font-bold outline-none resize-none custom-scroll leading-relaxed" placeholder="è¼¸å…¥ä»Šæ—¥å°è©±å…§å®¹æ‘˜è¦..."></textarea>
                    <input type="hidden" id="editingLogId" value="">
                    <div class="flex flex-wrap gap-1.5 mt-3">
                        <button onclick="insertQuick('newLogContent', 'ğŸ“µ æœªæ¥é›»è©±')" class="quick-insert-btn">ğŸ“µ æœªæ¥</button>
                        <button onclick="insertQuick('newLogContent', 'ğŸ“´ ç›´æ›é›»è©±')" class="quick-insert-btn">ğŸ“´ ç›´æ›</button>
                        <button onclick="insertQuick('newLogContent', 'ğŸ“ éœ€è¦å›é›»')" class="quick-insert-btn">ğŸ“ å›é›»</button>
                        <button onclick="insertQuick('newLogContent', 'ğŸ  æ¡ˆä»¶ä»‹ç´¹')" class="quick-insert-btn">ğŸ  ä»‹ç´¹</button>
                        <button onclick="insertQuick('newLogContent', 'ğŸ“ å·²å‚³ç°¡è¨Š')" class="quick-insert-btn">ğŸ“ ç°¡è¨Š</button>
                        <button onclick="insertQuick('newLogContent', 'ğŸ  é ç´„å¸¶çœ‹')" class="quick-insert-btn">ğŸ  å¸¶çœ‹</button>
                        <button onclick="insertQuick('newLogContent', 'â˜ï¸ é›»è©±è¶…è¯')" class="quick-insert-btn">â˜ï¸ è¶…è¯</button>
                        <button onclick="insertQuick('newLogContent', 'ğŸ‰ å·²ç¶“è²·åˆ°')" class="quick-insert-btn">ğŸ‰ è²·åˆ°</button>
                        <button onclick="insertQuick('newLogContent', 'ğŸ”‡ æ²’éœ€æ±‚')" class="quick-insert-btn">ğŸ”‡ æ²’éœ€æ±‚</button>
                        
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col bg-slate-50 p-4 rounded-3xl border border-slate-200 w-full md:max-w-4xl mx-auto shadow-inner">
                <label class="text-[10px] font-black text-slate-400 mb-3 uppercase italic tracking-widest pl-2">ğŸ“‹ æ­·å²ç¶“ç‡Ÿè»Œè·¡</label>
                <div class="flex-1 overflow-y-auto custom-scroll space-y-3 pr-2" id="logHistoryList"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-3 rounded-2xl hidden z-[100] text-xs font-black shadow-2xl"></div>

    <script>
        const STORAGE_KEY = 'crm_pro_v4_6_data';
        let buyers = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let currentClientIndex = -1;

        const statusOptions = ['ç¶“ç‡Ÿä¸­', 'Aè²·', 'å¤±è¯ä¸­', 'å¸¶çœ‹é', 'LINEå¥½å‹', 'ä¸ç¶“ç‡Ÿ'];
        const statusColors = {
            'ç¶“ç‡Ÿä¸­': 'bg-blue-100 text-blue-600',
            'Aè²·': 'bg-emerald-100 text-emerald-600',
            'å¤±è¯ä¸­': 'bg-slate-100 text-slate-400',
            'å¸¶çœ‹é': 'bg-orange-100 text-orange-600',
            'LINEå¥½å‹': 'bg-green-100 text-green-600',
            'ä¸ç¶“ç‡Ÿ': 'bg-slate-800 text-white'
        };

        function d(v, placeholder = 'ä¸é™') { 
            return (v && v.trim() !== '') ? v : `<span class="text-empty">${placeholder}</span>`; 
        }

        function formatRoom(val) {
            if (!val || val.trim() === '') return `<span class="text-empty">ä¸é™</span>`;
            if (val.includes('/')) {
                const p = val.split('/');
                const r = p[0] || 0;
                const w = p[1] || 0;
                return `${r}æˆ¿${w}è¡›`;
            }
            return `${val}æˆ¿`;
        }

        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(buyers)); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerHTML = m; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 2000); }
        
        function copy(text, label) {
            if (!text || text.trim() === '') return;
            const temp = document.createElement('textarea');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showToast(`ğŸ“‹ å·²è¤‡è£½ ${label}`);
        }

        function insertQuick(id, text) {
            const area = document.getElementById(id);
            const start = area.selectionStart;
            const space = (area.value.length > 0 && area.value[start-1] !== ' ') ? ' ' : '';
            area.value = area.value.substring(0, start) + space + text + area.value.substring(area.selectionEnd);
            area.focus();
        }

        function insertQuickTag(tag) {
            const area = document.getElementById('inputNote');
            let val = area.value.trim();
            if (val.includes(tag)) return;
            area.value = val + (val === '' ? '' : ' ') + tag;
            area.focus();
        }

        function clearDateFilter() { document.getElementById('searchLogDate').value = ''; render(); }

        function checkOverlap(valStr, minBound, maxBound) {
            if (!valStr || valStr.trim() === '') return true;
            const parts = valStr.toString().split(/[-~ /]+/).map(p => parseFloat(p)).filter(p => !isNaN(p));
            if (parts.length === 0) return true;
            const min = Math.min(...parts);
            const max = Math.max(...parts);
            const checkMin = minBound === null ? -Infinity : minBound;
            const checkMax = maxBound === null ? Infinity : maxBound;
            return min <= checkMax && max >= checkMin;
        }

        function render() {
            const container = document.getElementById('dataList');
            const kw = document.getElementById('searchInput').value.toLowerCase();
            const logDateSearch = document.getElementById('searchLogDate').value;
            const fStatus = document.getElementById('filterStatus').value;
            const fType = document.getElementById('filterType').value;
            const fBudget = document.getElementById('filterBudget').value;
            const fRoom = document.getElementById('filterRoom').value;
            const fAge = document.getElementById('filterAge').value;
            const fSize = document.getElementById('filterSize').value;
            const fParking = document.getElementById('filterParking').value;

            const filtered = buyers.filter(b => {
                if (logDateSearch) {
                    const hasLog = b.logs && b.logs.some(l => l.timestamp === logDateSearch);
                    if (!hasLog) return false;
                }
                const match = `${b.name}${b.phone}${b.area}${b.building}${b.note}${b.code}${b.address}`.toLowerCase().includes(kw) ||
                              (b.logs?.some(l => l.content.toLowerCase().includes(kw))) ||
                              (b.adminNote?.toLowerCase().includes(kw));
                if (!match) return false;
                if (fStatus !== 'å…¨éƒ¨' && b.status !== fStatus) return false;
                if (fType !== 'å…¨éƒ¨' && b.type && b.type !== '' && b.type !== fType) return false;
                if (fBudget !== 'ä¸é™') {
                    if (fBudget === '1000â†“' && !checkOverlap(b.budget, 0, 1000)) return false;
                    if (fBudget === '1000-2000' && !checkOverlap(b.budget, 1000, 2000)) return false;
                    if (fBudget === '2000-3500' && !checkOverlap(b.budget, 2000, 3500)) return false;
                    if (fBudget === '3500-5000' && !checkOverlap(b.budget, 3500, 5000)) return false;
                    if (fBudget === '5000â†‘' && !checkOverlap(b.budget, 5000, 999999)) return false;
                }
                if (fRoom !== 'ä¸é™' && b.roomRange && b.roomRange.trim() !== '') {
                    const r = parseInt(b.roomRange) || 0;
                    if (fRoom === '4' && r < 4) return false;
                    if (fRoom !== '4' && r != parseInt(fRoom)) return false;
                }
                if (fAge !== 'ä¸é™') {
                    if (fAge === '5' && !checkOverlap(b.age, 0, 5)) return false;
                    if (fAge === '5-15' && !checkOverlap(b.age, 5, 15)) return false;
                    if (fAge === '15-30' && !checkOverlap(b.age, 15, 30)) return false;
                    if (fAge === '30' && !checkOverlap(b.age, 30, 999)) return false;
                }
                if (fSize !== 'ä¸é™') {
                    if (fSize === '20â†“' && !checkOverlap(b.size, 0, 20)) return false;
                    if (fSize === '20-40' && !checkOverlap(b.size, 20, 40)) return false;
                    if (fSize === '40-60' && !checkOverlap(b.size, 40, 60)) return false;
                    if (fSize === '60â†‘' && !checkOverlap(b.size, 60, 9999)) return false;
                }
                if (fParking !== 'ä¸é™' && b.parking && b.parking !== '' && b.parking !== fParking) return false;
                return true;
            });

            container.innerHTML = filtered.map(b => {
                const idx = buyers.indexOf(b);
                const genderClass = b.name.includes('å°å§') ? 'border-female' : (b.name.includes('å…ˆç”Ÿ') ? 'border-male' : 'border-other');
                const areaTags = b.area ? b.area.split(/\s+/).filter(t => t) : [];
                const buildingTags = b.building ? b.building.split(/\s+/).filter(t => t) : [];
                const noteTags = b.note ? b.note.split(/\s+/).filter(t => t) : [];
                const latestLog = b.logs && b.logs.length > 0 ? b.logs[0] : null;

                return `
                    <div class="card p-5 md:p-6 ${genderClass} relative overflow-hidden card-hover">
                        <div class="absolute top-5 right-5 flex items-center">
                            <span class="budget-badge">ğŸ’° ${b.budget && b.budget.trim() !== '' ? `${b.budget}è¬` : `<span class="text-empty">ä¸é™</span>`}</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-3 mb-4 pr-32">
                            <div class="flex items-center gap-2">
                                <span onclick="copy('${b.code}', 'ç°¡ç¢¼')" class="bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded-full font-black cursor-copy hover:bg-blue-600">${b.code || 'ç„¡ä»£ç¢¼'}</span>
                                <h3 onclick="copy('${b.name}', 'å§“å')" class="text-lg md:text-xl font-black text-slate-900 clickable-name">${b.name}</h3>
                            </div>
                            <select onchange="updateQuickStatus(${idx}, this.value)" class="status-select ${statusColors[b.status]}">
                                ${statusOptions.map(opt => `<option value="${opt}" ${b.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs font-bold text-slate-500 w-full md:w-auto">
                                <span onclick="copy('${b.phone}', 'é›»è©±')" class="copy-hint hover:text-blue-500">ğŸ“ ${d(b.phone, 'æœªå¡«')}</span>
                                <span onclick="copy('${b.line}', 'LINE')" class="copy-hint text-green-600">ğŸ’¬ <span class="text-slate-500 mr-1">LINE:</span>${d(b.line, 'æœªå¡«')}</span>
                                ${b.address && b.address.trim() !== '' ? `<a href="https://www.google.com/maps/search/${encodeURIComponent(b.address)}" target="_blank" class="flex items-center gap-1 text-blue-600 hover:underline">ğŸ“ <span class="text-slate-500 mr-1">åœ°å€:</span>${b.address}</a>` : `<span>ğŸ“ <span class="text-slate-500 mr-1">åœ°å€:</span>${d(b.address, 'æœªå¡«')}</span>`}
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2.5 mb-4">
                            <span class="info-pill">ğŸ  ${d(b.type, 'ä¸é™')}</span>
                            <span class="info-pill">ğŸ›ï¸ ${formatRoom(b.roomRange)}</span>
                            <span class="info-pill">ğŸ“ ${b.size && b.size.trim() !== '' ? `${b.size}åª` : `<span class="text-empty">ä¸é™</span>`}</span>
                            <span class="info-pill">ğŸ¢ ${b.floor && b.floor.trim() !== '' ? `${b.floor}æ¨“` : `<span class="text-empty">ä¸é™</span>`}</span>
                            <span class="info-pill">ğŸš— ${d(b.parking, 'ä¸é™')}</span>
                            <span class="info-pill">ğŸ•°ï¸ ${b.age && b.age.trim() !== '' ? `${b.age}å¹´` : `<span class="text-empty">ä¸é™</span>`}</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-1.5 mb-4">
                            ${areaTags.map(t => `<a href="https://www.google.com/maps/search/${encodeURIComponent(t)}" target="_blank" class="area-tag">ğŸ—ºï¸ ${t}</a>`).join('')}
                            ${buildingTags.map(t => `<a href="https://www.google.com/maps/search/${encodeURIComponent(t)}" target="_blank" class="building-tag">ğŸ¢ ${t}</a>`).join('')}
                            ${noteTags.map(t => `<span class="note-tag"># ${t}</span>`).join('')}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-5">
                            <div onclick="openLogModal(${idx})" class="bg-amber-50/50 p-3 rounded-xl border border-amber-200 text-[11px] font-bold text-slate-600 italic cursor-pointer hover:bg-amber-100/50 transition-colors">
                                <div class="text-[9px] text-amber-500 mb-1 uppercase font-black tracking-widest">â­ å®¢æˆ¶ç‰¹è³ªç­†è¨˜</div>
                                <div class="line-clamp-2">${b.adminNote && b.adminNote.trim() !== '' ? b.adminNote : 'å°šæœªå¡«å¯«ç­†è¨˜...'}</div>
                            </div>
                            <div onclick="openLogModal(${idx})" class="bg-emerald-50/50 p-3 rounded-xl border border-emerald-100 text-[11px] font-bold text-slate-600 cursor-pointer hover:bg-emerald-100/50 transition-colors">
                                <div class="text-[9px] text-emerald-500 mb-1 uppercase font-black tracking-widest">ğŸ“… æœ€æ–°æ¥æ´½æ‘˜è¦</div>
                                <div class="line-clamp-2">${latestLog ? `${latestLog.timestamp}: ${latestLog.content}` : 'å°šç„¡æ¥æ´½ç´€éŒ„...'}</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t border-slate-50">
                            <span class="text-[9px] font-bold text-slate-300 uppercase italic">å»ºæª”: ${b.createdAt || '-'}</span>
                            <div class="flex gap-2">
                                <button onclick="editItem(${idx})" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-black hover:bg-slate-200">ç·¨è¼¯éœ€æ±‚</button>
                                <button onclick="openLogModal(${idx})" class="px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-black shadow-md hover:bg-blue-700">ç¶“ç‡Ÿå°è©±</button>
                                <button onclick="deleteBuyer(${idx})" class="px-3 py-2 text-slate-400 rounded-xl text-xs font-bold hover:text-red-500">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<div class="card p-12 text-center text-slate-400 font-bold italic">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å®¢æˆ¶</div>';
        }

        document.getElementById('mainForm').onsubmit = function(e) {
            e.preventDefault();
            const idx = parseInt(document.getElementById('editIndex').value);
            const data = {
                name: document.getElementById('inputName').value,
                code: document.getElementById('inputCode').value,
                phone: document.getElementById('inputPhone').value,
                line: document.getElementById('inputLine').value,
                address: document.getElementById('inputAddress').value,
                status: document.getElementById('inputStatus').value,
                budget: document.getElementById('inputBudget').value,
                type: document.getElementById('inputType').value,
                parking: document.getElementById('inputParking').value,
                roomRange: document.getElementById('inputRoomRange').value,
                floor: document.getElementById('inputFloor').value,
                size: document.getElementById('inputSize').value,
                age: document.getElementById('inputAge').value,
                area: document.getElementById('inputArea').value,
                building: document.getElementById('inputBuilding').value,
                note: document.getElementById('inputNote').value,
                createdAt: idx === -1 ? new Date().toLocaleDateString() : buyers[idx].createdAt,
                adminNote: idx === -1 ? '' : (buyers[idx].adminNote || ''),
                logs: idx === -1 ? [] : (buyers[idx].logs || [])
            };
            if (idx === -1) buyers.unshift(data); else buyers[idx] = data;
            save(); resetForm(); render(); showToast('âœ… å®¢æˆ¶è³‡æ–™å·²å„²å­˜');
        };

        function editItem(idx) {
            const b = buyers[idx];
            document.getElementById('editIndex').value = idx;
            document.getElementById('inputName').value = b.name;
            document.getElementById('inputCode').value = b.code || '';
            document.getElementById('inputPhone').value = b.phone || '';
            document.getElementById('inputLine').value = b.line || '';
            document.getElementById('inputAddress').value = b.address || '';
            document.getElementById('inputStatus').value = b.status;
            document.getElementById('inputBudget').value = b.budget || '';
            document.getElementById('inputType').value = b.type || '';
            document.getElementById('inputParking').value = b.parking || '';
            document.getElementById('inputRoomRange').value = b.roomRange || '';
            document.getElementById('inputFloor').value = b.floor || '';
            document.getElementById('inputSize').value = b.size || '';
            document.getElementById('inputAge').value = b.age || '';
            document.getElementById('inputArea').value = b.area || '';
            document.getElementById('inputBuilding').value = b.building || '';
            document.getElementById('inputNote').value = b.note || '';
            document.getElementById('formTitle').innerText = 'ğŸ“ ç·¨è¼¯å®¢æˆ¶éœ€æ±‚';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openLogModal(idx) {
            currentClientIndex = idx;
            const b = buyers[idx];
            document.getElementById('logModalTitle').innerText = `${b.name} - ç¶“ç‡Ÿè¨˜éŒ„è©³æƒ…`;
            document.getElementById('modalAdminNote').value = b.adminNote || '';
            document.getElementById('logModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; 
            resetLogForm(); renderLogs();
        }

        function saveNewLog() {
            const content = document.getElementById('newLogContent').value.trim();
            const logDateVal = document.getElementById('logDate').value;
            const logId = document.getElementById('editingLogId').value;
            if(!content) return;
            const logs = buyers[currentClientIndex].logs || [];
            if (logId) {
                const lIdx = logs.findIndex(l => l.id == logId);
                if (lIdx !== -1) { logs[lIdx].content = content; logs[lIdx].timestamp = logDateVal; }
            } else {
                logs.unshift({ id: Date.now(), timestamp: logDateVal, content });
            }
            logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            buyers[currentClientIndex].logs = logs;
            save(); renderLogs(); resetLogForm(); render(); showToast('âœ… ç¶“ç‡Ÿæ—¥èªŒå·²æ›´æ–°');
        }

        function renderLogs() {
            const list = document.getElementById('logHistoryList');
            const logs = buyers[currentClientIndex].logs || [];
            list.innerHTML = logs.map(l => `
                <div class="p-4 bg-white rounded-2xl border border-slate-100 flex gap-4 items-start shadow-sm w-full group hover:border-blue-200 cursor-pointer transition-all" onclick="editLog(${l.id})">
                    <div class="min-w-[90px] text-[10px] font-black text-emerald-600 bg-emerald-50 px-2 py-1.5 rounded-lg text-center shadow-sm border border-emerald-100">${l.timestamp}</div>
                    <div class="flex-1 text-[13px] font-bold text-slate-700 whitespace-pre-wrap leading-relaxed">${l.content}</div>
                    <button onclick="event.stopPropagation(); deleteLog(${l.id})" class="opacity-0 group-hover:opacity-100 px-3 py-1.5 text-red-400 text-[10px] font-bold hover:bg-red-50 rounded-lg transition-all">åˆªé™¤</button>
                </div>
            `).join('') || '<div class="text-center text-slate-300 py-16 font-bold italic">ç›®å‰æ²’æœ‰æ­·å²æ¥æ´½ç´€éŒ„</div>';
        }

        function editLog(logId) {
            const log = buyers[currentClientIndex].logs.find(l => l.id == logId);
            if(log) {
                document.getElementById('newLogContent').value = log.content;
                document.getElementById('logDate').value = log.timestamp;
                document.getElementById('editingLogId').value = log.id;
                document.getElementById('logFormTitle').innerText = 'ğŸ“ ä¿®æ”¹æ—¥èªŒå…§å®¹';
                document.getElementById('btnSaveLog').innerText = 'ç¢ºèªæ›´æ–°';
                document.getElementById('newLogContent').focus();
            }
        }

        function deleteLog(logId) { if(confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å‰‡æ—¥èªŒå—ï¼Ÿ')) { buyers[currentClientIndex].logs = buyers[currentClientIndex].logs.filter(l => l.id != logId); save(); renderLogs(); render(); } }
        function updateAdminNoteInModal() { buyers[currentClientIndex].adminNote = document.getElementById('modalAdminNote').value; save(); render(); showToast('â­ ç‰¹è³ªç­†è¨˜å·²å„²å­˜'); }
        function closeLogModal() { document.getElementById('logModal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        function resetLogForm() { document.getElementById('newLogContent').value = ''; document.getElementById('logDate').valueAsDate = new Date(); document.getElementById('editingLogId').value = ''; document.getElementById('logFormTitle').innerText = 'âœï¸ ç•¶æ¬¡æ¥æ´½ç´€éŒ„'; document.getElementById('btnSaveLog').innerText = 'å„²å­˜æ—¥èªŒ'; }
        function resetForm() { 
            document.getElementById('mainForm').reset(); 
            document.getElementById('editIndex').value = "-1"; 
            document.getElementById('formTitle').innerText = 'æ–°å¢è²·æ–¹';
            document.getElementById('inputType').value = "";
            document.getElementById('inputParking').value = "";
        }
        function deleteBuyer(idx) { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²·æ–¹æ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆæ­¤å‹•ä½œä¸å¯é‚„åŸï¼‰')) { buyers.splice(idx, 1); save(); render(); } }
        function updateQuickStatus(idx, s) { buyers[idx].status = s; save(); render(); showToast(`ğŸ“ å®¢æˆ¶ç‹€æ…‹å·²åˆ‡æ›ç‚ºï¼š${s}`); }

        // --- åŒ¯å‡ºåŠŸèƒ½å¯¦ä½œ ---
        function exportToCSV() {
            if (buyers.length === 0) { showToast('âŒ ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º'); return; }
            
            const headers = ["å§“å", "ç°¡ç¢¼", "é›»è©±", "LINE", "é€šè¨Šåœ°å€", "ç‹€æ…‹", "é ç®—", "é¡å‹", "è»Šä½", "æˆ¿è¡›", "æ¨“å±¤", "åªæ•¸", "å±‹é½¡", "å€åŸŸ", "ç¤¾å€", "å‚™è¨»", "å»ºæª”æ—¥æœŸ", "ç‰¹è³ªç­†è¨˜", "æ­·å²æ—¥èªŒ"];
            
            const rows = buyers.map(b => {
                const logsStr = (b.logs || []).map(l => `[${l.timestamp}]${l.content}`).join(' | ');
                return [
                    b.name, b.code, b.phone, b.line, b.address, b.status, b.budget, b.type, b.parking, b.roomRange, b.floor, b.size, b.age, b.area, b.building, b.note, b.createdAt, b.adminNote, logsStr
                ].map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(",");
            });

            const csvContent = "\ufeff" + headers.join(",") + "\n" + rows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `CRM_Buyers_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('âœ… è³‡æ–™åŒ¯å‡ºæˆåŠŸ');
        }

        // --- åŒ¯å…¥åŠŸèƒ½å¯¦ä½œ ---
        function importFromCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/);
                    if (lines.length < 2) throw new Error("æª”æ¡ˆå…§å®¹ä¸è¶³");

                    const newBuyers = [];
                    // è·³éæ¨™é¡Œåˆ—
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        // ç°¡å–®çš„ CSV è§£æï¼ˆè™•ç†å¼•è™Ÿï¼‰
                        const regex = /(".*?"|[^,]+|(?<=,)(?=,)|(?<=^)(?=,))/g;
                        const cells = lines[i].match(regex).map(c => c.replace(/^"|"$/g, '').replace(/""/g, '"'));

                        if (cells.length < 5) continue; // è‡³å°‘è¦æœ‰åŸºæœ¬æ¬„ä½

                        // è§£ææ­·å²æ—¥èªŒ
                        const logsStr = cells[18] || "";
                        const logs = logsStr.split(' | ').filter(s => s).map(s => {
                            const match = s.match(/^\[(.*?)\](.*)/);
                            return match ? { id: Date.now() + Math.random(), timestamp: match[1], content: match[2] } : null;
                        }).filter(l => l);

                        const buyer = {
                            name: cells[0] || "æœªå‘½å",
                            code: cells[1] || "",
                            phone: cells[2] || "",
                            line: cells[3] || "",
                            address: cells[4] || "",
                            status: cells[5] || "ç¶“ç‡Ÿä¸­",
                            budget: cells[6] || "",
                            type: cells[7] || "",
                            parking: cells[8] || "",
                            roomRange: cells[9] || "",
                            floor: cells[10] || "",
                            size: cells[11] || "",
                            age: cells[12] || "",
                            area: cells[13] || "",
                            building: cells[14] || "",
                            note: cells[15] || "",
                            createdAt: cells[16] || new Date().toLocaleDateString(),
                            adminNote: cells[17] || "",
                            logs: logs
                        };

                        // é¿å…é‡è¤‡åŒ¯å…¥ï¼ˆä»¥å§“å+é›»è©±ç‚ºåŸºæº–ï¼‰
                        const exists = buyers.some(b => b.name === buyer.name && b.phone === buyer.phone);
                        if (!exists) {
                            newBuyers.push(buyer);
                        }
                    }

                    if (newBuyers.length > 0) {
                        buyers = [...newBuyers, ...buyers];
                        save();
                        render();
                        showToast(`âœ… æˆåŠŸåŒ¯å…¥ ${newBuyers.length} ç­†æ–°è³‡æ–™`);
                    } else {
                        showToast('â„¹ï¸ æœªåµæ¸¬åˆ°æ–°å®¢æˆ¶æˆ–æ ¼å¼ä¸ç¬¦');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('âŒ åŒ¯å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æ˜¯å¦ç‚ºæœ¬ç³»çµ±åŒ¯å‡ºçš„ CSV');
                }
                input.value = ""; // æ¸…ç©º input
            };
            reader.readAsText(file);
        }

        window.onload = render;
    </script>
</body>
</html>
